"use strict";function log(e,t="[INFO]",o="white-text"){var a=$("#console"),n=$("<span>");n.attr("class",o),""!=t&&(t+=" "),n.html(t+e),a.append(n),a.append("<br>"),a.scrollTop(a[0].scrollHeight-a.height())}function updateCommands(e=!0){$("#updateCommands").prop("disabled",!0),e&&log("Aggiornamento lista comandi in corso...","[INFO]","yellow-text"),commands={};var t=$("#commands").val(),o=t.split(/;$/gm);for(var a in o){"\n"===o[a].charAt(0)&&(o[a]=o[a].substr(1));var n=o[a].splitTwo(" > ");n[0]in commands?commands[n[0]].push(n[1]):commands[n[0]]=[n[1]]}localStorage.setItem("commands",$("#commands").val().replace(/\n/g,"///////////")),e&&log("Aggiornamento lista comandi completato!","[INFO]","green-text"),$("#updateCommands").prop("disabled",!1)}function htmlEncode(e){return $("<div>").text(e).html()}function updateAnalyzer(){request("getUpdates",{offset:updateOffset},function(e){var t={};if("stop"==started)return $("#startBot").prop("disabled",!1),log("Bot arrestato!","[INFO]","blue-text"),started=0,!0;setTimeout(updateAnalyzer,$("#ufUpdAnalyzer").prop("checked")?0:500),e.result!==[]&&e.result&&e.result.length>0&&(debug&&(log("Received update "+htmlEncode(JSON.stringify(e)),"[DEBUG]"),startTime=(new Date).getTime(),log("Start Time: "+startTime,"[DEBUG]")),t=e.result[0],updateOffset=t.update_id,analyzeUpdate(t),updateOffset++),0==started&&(localStorage.setItem("botToken",$("#token").val()),log("Bot avviato! Attenzione: Se chiudi questa pagina, verrà anche arrestato il tuo bot!","[INFO]","blue-text"),log("/help per i comandi della console."),$("#stopBot").prop("disabled",!1),setTimeout(function(){request("getMe",{},function(e){botInfo=e.result,botUsername=botInfo.username,log("Info Bot:<br>Nome: "+htmlEncode(botInfo.first_name)+'<br>Username: <a href="https://t.me/'+botUsername+'">@'+botUsername+"</a>")})},0),started=1)},function(e){var t=e.responseText,o=JSON.parse(e.responseText),a="Errore sconosciuto";403==o.error_code||404==o.error_code?a="Possibile token errato o non valido":409==o.error_code&&(a="Possibile conflitto"),log("Errore nella connessione: "+t+"<br />"+a,"[ERRORE]","red-text"),$("#stopBot").prop("disabled",!0),$("#startBot").prop("disabled",!1),started=0})}function updateBotSettings(){if(""!=botToken&&botToken){if(debug){log("Updating bot settings...","[DEBUG]");var e=(new Date).getTime()}localStorage.setItem("botSettings",JSON.stringify({parseMode:$("#parseMode").val(),wpPreview:$("#wpPreview").val(),autoStart:$("#autoStart").prop("checked"),logAllMsg:$("#logAllMsg").prop("checked"),ufUpdAnalyzer:$("#ufUpdAnalyzer").prop("checked"),selectedChatId:selectedChatId,knownChatIDs:JSON.stringify(knownChatIDs)})),debug&&log("Updated bot settings<br />Response time: "+((new Date).getTime()-e)+"ms","[DEBUG]")}}function analyzeUpdate(e){var t,o,a,n,s,i="",l=0,r="",d=!1,c=0;if(debug&&log("Analysing update: "+htmlEncode(JSON.stringify(e)),"[DEBUG]"),t="message"in e?e.message:{},!("chat"in t))return log("Messaggio non supportato","[WARNING]","yellow-text"),!1;if(l=t.chat.id,"title"in t.chat&&(a=t.chat.title,d=!0),"from"in t&&("first_name"in t.from?(s=t.from.first_name,r=s):s="","last_name"in t.from?(n=t.from.last_name,r+=" "+n):n="",c="id"in t.from?t.from.id:0),o=void 0!==a?a:r,"text"in t)i="/"==t.text.charAt(0)?t.text.replace("@"+botUsername,""):t.text;else if("photo"in t){var p=t.photo[t.photo.length-1].file_id,m=t.caption;(selectedChatId==l||$("#logAllMsg").prop("checked"))&&request("getFile",{file_id:p},function(e){var t="https://api.telegram.org/file/bot"+botToken+"/"+e.result.file_path;log('<span class="sentImg"><img src="'+t+'"><br>'+(m||"")+"</span>","["+(d?htmlEncode(a)+": ":"")+htmlEncode(r)+"]",selectedChatId==l?"yellow-text":"white-text")},function(e){e.responseText&&log(e.responseText,"[ERRORE]","red-text")}),i=""}else i="Messaggio non supportato!";(selectedChatId==l||$("#logAllMsg").prop("checked"))&&i&&log(htmlEncode(i),"["+(d?htmlEncode(a)+": ":"")+htmlEncode(r)+"]",selectedChatId==l?"yellow-text":"white-text"),knownChatIDs[l]=o;var g=["{CHATID}","{USERID}","{CHATTITLE}","{NAME}","{FIRSTNAME}","{LASTNAME}","{MSGTEXT}","{HTMLESCAPEDMSGTEXT}"],u=[l,c,"HTML"==$("#parseMode").val()?htmlEncode(o):o,"HTML"==$("#parseMode").val()?htmlEncode(r):r,"HTML"==$("#parseMode").val()?htmlEncode(s):s,"HTML"==$("#parseMode").val()?htmlEncode(n):n,i,htmlEncode(i)];if("/fileid"==m&&sendMessage(l,"FileID: <code>"+p+"</code>",!1,"HTML"),i in commands&&""!=i)for(var h of commands[i]){var f=h.replaceArray(g,u);debug&&log("Text to send: "+htmlEncode(f),"[DEBUG]"),sendMessage(l,f)}if("any"in commands)for(var h in commands.any){f=commands.any[h].replaceArray(g,u);debug&&log("Text to send: "+htmlEncode(f),"[DEBUG]"),sendMessage(l,f)}debug&&log("Response Time: "+((new Date).getTime()-startTime)+"ms","[DEBUG]")}function sendMessage(e,t,o=!1,a=!1,n=!1){if(a||(a=$("#parseMode").val()),n||(n=$("#wpPreview").val()),0!=t.indexOf("photo")){if(null!=e&&""!=e||e){i={chat_id:e,text:t,parse_mode:a,disable_web_page_preview:n};return request("sendMessage",i,function(t){o&&log(t.result.text,"[Messaggio inviato: "+(e in knownChatIDs?knownChatIDs[e]:e)+"]","green-text")},function(e){var t=e.responseText;log("Errore nell'invio del messaggio: "+t,"[ERRORE]","red-text")},!0),!0}return!1}var s=t.splitTwo(" ")[1],i={chat_id:e,photo:s};request("sendPhoto",i,function(t){o&&request("getFile",{file_id:s},function(t){var o="https://api.telegram.org/file/bot"+botToken+"/"+t.result.file_path;log('<span class="sentImg"><img src="'+o+'"></span>',"[Messaggio inviato: "+(e in knownChatIDs?knownChatIDs[e]:e)+"]","green-text")},function(e){e.responseText&&log(e.responseText,"[ERRORE]","red-text")})},function(e){var t=e.responseText;log("Errore nell'invio del messaggio: "+t,"[ERRORE]","red-text")},!0)}function request(e,t={},o=function(){},a=function(){},n=!0){$.ajax({url:"https://api.telegram.org/bot"+botToken+"/"+e,async:n,method:"POST",data:t,dataType:"json",success:o,error:a})}function sendCommand(e){if(""!=botToken&&botToken&&1==started)switch(e.splitTwo(" ",1)[0]){case"/help":log("Menù comandi:<br />/help: visualizza questo menù di aiuto<br />/select: GUI per selezionare la chat in cui inviare i messaggi<br />&lt;messaggio&gt;: invia messaggio nella chat_id selezionata","");break;case"/select":var t=e.splitTwo(" ");if(1 in t&&t[1])selectedChatId=t[1],log(0==selectedChatId?"Rimossa selezione chat_id!":"Selezionato "+selectedChatId+"!","[INFO]","green-text"),updateBotSettings();else if($.isEmptyObject(knownChatIDs))log("Nessun chat_id conosciuto. Impossibile mostrare la GUI. Seleziona un chat_id manualmente con /select &lt;chat_id&gt;","[ERRORE]","red-text");else{var o="";for(var a in knownChatIDs)o+='<option value="'+a+'"'+(a==selectedChatId?" selected":"")+">"+htmlEncode(knownChatIDs[a])+"</option>";$("#selectChatId").html(o).formSelect(),$("#selectChatIdModal").modal("open")}break;default:"/"==e.charAt(0)?log("Comando non valido. /help per una lista completa di comandi.","[ERRORE]","red-text"):0!=selectedChatId?(e=e.replace(/\\n/g,"\n"),e.replace(new RegExp(" ","g"),"").length>0?e.length<=4096?sendMessage(selectedChatId,e,!0):log("Messaggio troppo lungo. Caratteri massimi consentiti: 4096 caratteri.","[ERRORE]","red-text"):log("Messaggio nullo.","[ERRORE]","red-text")):log("Per favore, prima di tentare di inviare un messaggio, usa /select","[ERRORE]","red-text")}else log('Prima di scrivere comandi, perfavore, metti il token del bot. Se lo hai già fatto, assicurati di aver avviato il bot cliccando il pulsante "Avvia"',"[ERRORE]","red-text")}var updateAnalyzer,botInfo,botToken="",updateOffset=-1,cookies=localStorage,commands={},started=0,selectedChatId=0,lastCommand="",botUsername="",knownChatIDs={},debug=!1,startTime=0;String.prototype.splitTwo=function(e){var t=this.split(e),o=this.substr(t[0].length+e.length);return[t[0],o]},String.prototype.replaceArray=function(e,t){for(var o,a=this,n=0;n<e.length;n++)o=new RegExp(e[n],"g"),a=a.replace(o,t[n]);return a},$(document).ready(function(){if(-1!=location.href.indexOf("#")){var e=location.href.substr(location.href.indexOf("#")+1);"debug=1"==e&&(debug=!0,setTimeout(function(){log("DEBUG mode enabled","[DEBUG]")},0))}if($("#applyChatId").on("click",function(){sendCommand("/select "+$("#selectChatId").val())}),$("#removeChatId").on("click",function(){sendCommand("/select 0")}),$("#autoStart").on("change",updateBotSettings),$("#logAllMsg").on("change",updateBotSettings),$("#parseMode").on("change",updateBotSettings),$("#wpPreview").on("change",updateBotSettings),$("#ufUpdAnalyzer").on("change",updateBotSettings),$("#consoleCommandsGo").click(function(){var e=$("#consoleCommands");e.val().replace(/\\n/g,"\n");lastCommand=e.val(),sendCommand(e.val()),e.val("")}),$("#consoleCommands").focus(function(){$("#consoleCommandsContainer").css("background","rgb(15, 15, 15)")}),$("#consoleCommands").blur(function(){$("#consoleCommandsContainer").css("background","#000")}),$("#consoleCommands").keyup(function(e){13==e.keyCode?$("#consoleCommandsGo").click():38==e.keyCode&&$(this).val(lastCommand)}),$("#startBot").click(function(){botToken=$("#token").val(),""!=botToken&&botToken?($("#startBot").prop("disabled",!0),log("Avviando il bot... Connessione in corso ai server telegram...","[INFO]","blue-text"),updateAnalyzer()):log("Bot non avviato! Bot token vuoto!","[ERRORE]","red-text")}),$("#stopBot").click(function(){started="stop",$("#stopBot").prop("disabled",!0),log("Richiesta di arresto inviata!","[INFO]","yellow-text")}),$("#commands").blur(function(){updateCommands(!0)}),$("#updateCommands").click(updateCommands),"commands"in cookies?$("#commands").val(cookies.commands.split("///////////").join("\n")):$("#commands").val("/start > Messaggio di avvio!;\n/help > Menù di aiuto!;"),"botToken"in cookies&&($("#token").val(cookies.botToken),botToken=$("#token").val()),"botSettings"in cookies){var t=JSON.parse(cookies.botSettings);"parseMode"in t&&$("#parseMode").val(t.parseMode),"wpPreview"in t&&$("#wpPreview").val(t.wpPreview),"autoStart"in t&&($("#autoStart").prop("checked",t.autoStart),1==t.autoStart&&setTimeout(function(){log("Bot in avvio secondo le tue impostazioni...","[INFO]","yellow-text"),""!=botToken&&botToken?$("#startBot").click():(log("Bot token vuoto.","[ERRORE]","red-text"),$("#autoStart").prop("checked",!1),updateBotSettings())},0)),"logAllMsg"in t&&$("#logAllMsg").prop("checked",t.logAllMsg),"knownChatIDs"in t&&(knownChatIDs=JSON.parse(t.knownChatIDs)),"ufUpdAnalyzer"in t&&$("#ufUpdAnalyzer").prop("checked",t.ufUpdAnalyzer),"selectedChatId"in t&&0!=t.selectedChatId&&setTimeout(function(){selectedChatId=t.selectedChatId,!selectedChatId in knownChatIDs?request("getChat",{chat_id:selectedChatId},function(e){},function(e){var t=JSON.parse(e.responseText),o=t.error_code;t.description;log(403==o?"L'utente selezionato precedentemente ha bloccato il bot o non lo ha mai avviato.":"Errore sconosciuto: "+JSON.stringify(t),"[ERRORE]","red-text"),selectedChatId=""}):log("Selezionata chat "+knownChatIDs[selectedChatId]+" come da sessione precedente.","[INFO]","yellow-text")},0)}setTimeout(function(){M.updateTextFields(),M.textareaAutoResize($("#commands")),$(".tooltipped").tooltip(),$("select").formSelect(),$(".modal").modal()},0),updateCommands(!1)});